<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Feasibility Study</title>

  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }

    /* ===== MENU INTERNO ===== */
    .submenu {
      text-align: center;
      margin-bottom: 15px;
    }

    .submenu button {
      padding: 10px 18px;
      margin: 0 6px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #e0e0e0;
    }

    .submenu button:hover {
      background: #cfcfcf;
    }

    /* ===== SEÇÕES ===== */
    .section {
      display: none;
    }

    /* ===== CONTAINER DOS GRÁFICOS ===== */
    .chart-container {
      position: relative;
      width: 100%;
      height: 520px;
      overflow: hidden;
      background: transparent;
    }

    /* ===== FUNDO ===== */
    .chart-container::before {
      content: "";
      position: absolute;
      inset: -30%;
      background-image: url('fundo.jpg'); /* raiz do repositório */
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.25;
      filter: brightness(1.25);
      z-index: 0;
    }

    .chart-container > * {
      position: relative;
      z-index: 1;
    }

    /* ===== TOOLTIP BUBBLE ===== */
    #customTooltip {
      position: absolute;
      background: #ffffff;
      border: 1px solid #bbb;
      padding: 8px 10px;
      font-size: 13px;
      line-height: 1.4;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      border-radius: 4px;
      display: none;
      pointer-events: none;
      z-index: 1000;
      white-space: nowrap;
    }
  </style>

  <script>
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(init);

    let scatterDrawn = false;
    let bubbleDrawn = false;

    function init() {
      showSection('scatterSection');
    }

    function showSection(id) {
      document.querySelectorAll('.section')
        .forEach(s => s.style.display = 'none');

      const section = document.getElementById(id);
      section.style.display = 'block';

      if (id === 'scatterSection' && !scatterDrawn) {
        drawScatter();
        scatterDrawn = true;
      }

      if (id === 'bubbleSection' && !bubbleDrawn) {
        drawBubble();
        bubbleDrawn = true;
      }
    }

    /* ================= SCATTER (INALTERADO) ================= */
    async function drawScatter() {
      const csvUrl =
        'https://docs.google.com/spreadsheets/d/e/2PACX-1vSHkysTN6roFag5cFJv97rmXIsO9vKLKaAXmJxbeAD0v4klws329T8nwBI1ftUFKvrukkvLYM9vPysK/pub?gid=1894723608&single=true&output=csv';

      const res = await fetch(csvUrl);
      const csv = await res.text();

      const rows = csv.trim().split('\n').filter(r => r.trim());

      const data = new google.visualization.DataTable();
      data.addColumn('string', 'Name_Chart');
      data.addColumn('number', 'Measured + Indicated (%)');
      data.addColumn('number', 'Proved + Probable / Measured + Indicated (%)');
      data.addColumn({ type: 'string', role: 'tooltip', p: { html: true } });

      const links = [];

      for (let i = 1; i < rows.length; i++) {
        const r = rows[i].split(',').map(c => c.replace(/"/g, '').trim());
        if (r.length < 6) continue;

        const name = r[0];
        const mi = parseFloat(r[1]);
        const ratio = parseFloat(r[2]);
        const resources = r[3];
        const oreType = r[4];
        const link = r[5];

        if (isNaN(mi) || isNaN(ratio)) continue;

        const tooltip = `
          <div style="padding:8px; font-size:13px">
            <strong>${name}</strong><br><br>
            <b>Measured + Indicated:</b> ${mi}<br>
            <b>P+P / M+I:</b> ${ratio}<br>
            <b>Resources (Mt):</b> ${resources}<br>
            <b>Ore Type:</b> ${oreType}<br>
            <span style="color:#0066cc">Click to open source</span>
          </div>
        `;

        data.addRow([name, mi, ratio, tooltip]);
        links.push(link);
      }

      const options = {
        title: 'Feasibility Study',
        hAxis: { title: 'Measured + Indicated (%)', minValue: 0, maxValue: 1 },
        vAxis: { title: 'P+P / M+I (%)', minValue: 0, maxValue: 1 },
        height: 520,
        pointSize: 10,
        tooltip: { isHtml: true },
        backgroundColor: 'transparent',
        chartArea: { backgroundColor: 'transparent' }
      };

      const chart = new google.visualization.ScatterChart(
        document.getElementById('scatterChart')
      );

      google.visualization.events.addListener(chart, 'select', () => {
        const sel = chart.getSelection();
        if (sel.length && links[sel[0].row]) {
          window.open(links[sel[0].row], '_blank');
        }
      });

      chart.draw(data, options);
    }

    /* ================= BUBBLE (ORIGINAL PRESERVADO) ================= */
    async function drawBubble() {
      const csvUrl =
        'https://docs.google.com/spreadsheets/d/e/2PACX-1vSHkysTN6roFag5cFJv97rmXIsO9vKLKaAXmJxbeAD0v4klws329T8nwBI1ftUFKvrukkvLYM9vPysK/pub?gid=1894723608&single=true&output=csv';

      const res = await fetch(csvUrl);
      const csv = await res.text();

      const rows = csv.trim().split('\n').filter(r => r.trim());
      const data = new google.visualization.DataTable();

      data.addColumn('string', 'ID');
      data.addColumn('number', 'Measured + Indicated');
      data.addColumn('number', 'P+P / M+I');
      data.addColumn('number', 'Resources (Color)');
      data.addColumn('number', 'Resources (Size)');
      data.addColumn('string', 'Name');
      data.addColumn('string', 'OreType');
      data.addColumn('string', 'Link');

      for (let i = 1; i < rows.length; i++) {
        const r = rows[i].split(',').map(c => c.replace(/"/g, '').trim());
        if (r.length < 6) continue;

        const name = r[0];
        const mi = parseFloat(r[1]);
        const ratio = parseFloat(r[2]);
        const resources = parseFloat(
          r[3].replace(/\./g, '').replace(',', '.').replace(/[^\d.]/g, '')
        );
        const oreType = r[4];
        const link = r[5];

        if (isNaN(mi) || isNaN(ratio) || isNaN(resources)) continue;

        data.addRow(['', mi, ratio, resources, resources, name, oreType, link]);
      }

      const options = {
        title: 'Feasibility Study',
        hAxis: { title: 'Measured + Indicated (%)', minValue: 0, maxValue: 1 },
        vAxis: { title: 'P+P / M+I (%)', minValue: 0, maxValue: 1 },
        colorAxis: { colors: ['#9ecae1', '#08306b'] },
        sizeAxis: { minSize: 8, maxSize: 45 },
        bubble: { textStyle: { fontSize: 0 } },
        tooltip: { trigger: 'none' },
        backgroundColor: 'transparent',
        chartArea: { backgroundColor: 'transparent' },
        height: 520
      };

      const chartDiv = document.getElementById('bubbleChart');
      const chart = new google.visualization.BubbleChart(chartDiv);
      const tooltip = document.getElementById('customTooltip');

      google.visualization.events.addListener(chart, 'onmouseover', e => {
        if (e.row == null) return;

        const cli = chart.getChartLayoutInterface();
        const x = cli.getXLocation(data.getValue(e.row, 1));
        const y = cli.getYLocation(data.getValue(e.row, 2));

        tooltip.innerHTML = `
          <strong>${data.getValue(e.row, 5)}</strong><br><br>
          <b>Measured + Indicated:</b> ${data.getValue(e.row, 1)}<br>
          <b>P+P / M+I:</b> ${data.getValue(e.row, 2)}<br>
          <b>Resources (Mt):</b> ${data.getValue(e.row, 3)}<br>
          <b>Ore Type:</b> ${data.getValue(e.row, 6)}<br>
          <span style="color:#0066cc">Click to open source</span>
        `;

        tooltip.style.left = chartDiv.offsetLeft + x + 15 + 'px';
        tooltip.style.top = chartDiv.offsetTop + y - 10 + 'px';
        tooltip.style.display = 'block';
      });

      google.visualization.events.addListener(chart, 'onmouseout', () => {
        tooltip.style.display = 'none';
      });

      google.visualization.events.addListener(chart, 'select', () => {
        const sel = chart.getSelection();
        if (!sel.length) return;

        const link = data.getValue(sel[0].row, 7);
        if (link) window.open(link, '_blank');
      });

      chart.draw(data, options);
    }
  </script>
</head>

<body>

  <div class="submenu">
    <button onclick="showSection('scatterSection')">Scatter Chart</button>
    <button onclick="showSection('bubbleSection')">Bubble Chart</button>
  </div>

  <div id="scatterSection" class="section">
    <div class="chart-container">
      <div id="scatterChart"></div>
    </div>
  </div>

  <div id="bubbleSection" class="section">
    <div class="chart-container">
      <div id="bubbleChart"></div>
    </div>
  </div>

  <div id="customTooltip"></div>

</body>

